---
- name: "Install Docker on apt-based systems"
  when: ansible_facts['pkg_mgr'] == 'apt'
  block:
    - name: Import Docker GPG key
      ansible.builtin.apt_key:
        url: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}/gpg"
        state: "present"

    - name: "Add Docker repository to APT"
      ansible.builtin.apt_repository:
        repo: "deb https://download.docker.com/linux/{{ ansible_facts.distribution | lower }} {{ ansible_facts.distribution_release }} stable"
        state: "present"

- name: "Add Docker repository to DNF"
  ansible.builtin.yum_repository:
    name: "docker-ce"
    description: "Docker CE Stable - $basearch"
    baseurl: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}/$releasever/$basearch/stable"
    gpgcheck: true
    gpgkey: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}/gpg"
    enabled: true
  when: ansible_facts['pkg_mgr'] == "dnf"

- name: "Install Docker"
  ansible.builtin.package:
    name: "docker-ce"
    state: "present"
    update_cache: true
  when: ansible_facts['pkg_mgr'] != 'atomic_container'

- name: "Configure Docker daemon"
  ansible.builtin.template:
    src: "templates/dockerdaemon.json.j2"
    dest: "/etc/docker/daemon.json"
    mode: "0644"
  when: ansible_facts['pkg_mgr'] != 'atomic_container'

- name: "Start and enable Docker daemon"
  ansible.builtin.systemd:
    name: "docker"
    enabled: true
    state: "started"
    masked: false

- name: "Add user to docker group: {{ admin_user_name }}"
  ansible.builtin.user:
    append: true
    groups: "docker"
    name: "{{ admin_user_name }}"

- name: "Install Docker Plugins specifically for CoreOS systems"
  when: ansible_facts['pkg_mgr'] == 'atomic_container'
  block:
    - name: "Create Docker plugin directory"
      ansible.builtin.file:
        path: "/usr/local/lib/docker/cli-plugins/"
        state: "directory"
        mode: "0755"

    - name: "Install Docker Compose v2 plugin"
      ansible.builtin.get_url:
        url: "https://github.com/docker/compose/releases/download/v2.40.0/docker-compose-linux-{{ ansible_facts.architecture }}"
        dest: "/usr/local/lib/docker/cli-plugins/docker-compose"
        mode: "0755"
        checksum: >-
          {%- if ansible_facts.architecture == 'aarch64' -%}
            sha256:fa99ca94c96c8cae4024493581a20049764ce723558991d0d1526c1c7b791a79
          {%- else -%}
            sha256:ca2ee9184773f8e0d21a3387320dabde4d853cd39dd3befd2ba2e05d9c81b72d
          {%- endif -%}

    - name: "Install Docker Buildx plugin"
      ansible.builtin.get_url:
        url: "https://github.com/docker/buildx/releases/download/v0.29.0/buildx-v0.29.0.linux-{{ 'arm64' if ansible_facts.architecture == 'aarch64' else 'amd64' }}"
        dest: "/usr/local/lib/docker/cli-plugins/docker-buildx"
        mode: "0755"
        checksum: >-
          {%- if ansible_facts.architecture == 'aarch64' -%}
            sha256:14e50940aef67c4b46f6b03a5ccc3851a30f883e751a61048a4bc80b8832a840
          {%- else -%}
            sha256:d02d47061bede1b90d34bf6562a5f39e686773e97cf9d00e7114b3c1e269e524
          {%- endif -%}
...
