---
- name: "Add Docker repository to APT"
  ansible.builtin.deb822_repository:
    architectures: "amd64"
    components: "stable"
    name: "docker"
    suites: "{{ ansible_facts['distribution_release'] }}"
    signed_by: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}/gpg"
    types: "deb"
    uris: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}"
  when: ansible_facts['pkg_mgr'] == 'apt'

- name: "Add Docker repository to DNF"
  ansible.builtin.yum_repository:
    name: "docker-ce"
    description: "Docker CE Stable - $basearch"
    baseurl: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}/$releasever/$basearch/stable"
    gpgcheck: true
    gpgkey: "https://download.docker.com/linux/{{ ansible_facts.distribution | lower }}/gpg"
    enabled: true
  when: ansible_facts['pkg_mgr'] == "dnf"

- name: "Install Docker"
  ansible.builtin.package:
    name: "docker-ce"
    state: "present"
    update_cache: true
  when: ansible_facts['pkg_mgr'] != 'atomic_container'

- name: "Configure Docker daemon"
  ansible.builtin.template:
    src: "templates/dockerdaemon.json.j2"
    dest: "/etc/docker/daemon.json"
    mode: "0644"
  when: ansible_facts['pkg_mgr'] != 'atomic_container'

- name: "Start and enable Docker daemon"
  ansible.builtin.systemd:
    name: "docker"
    enabled: true
    state: "started"
    masked: false

- name: "Add user to docker group: {{ admin_user_name }}"
  ansible.builtin.user:
    append: true
    groups: "docker"
    name: "{{ admin_user_name }}"

- name: "Install Docker Plugins specifically for CoreOS systems"
  when: ansible_facts['pkg_mgr'] == 'atomic_container'
  block:
    - name: "Create Docker plugin directory"
      ansible.builtin.file:
        path: "/usr/local/lib/docker/cli-plugins/"
        state: "directory"
        mode: "0755"

    - name: "Install Docker Compose v5 plugin"
      ansible.builtin.get_url:
        url: "https://github.com/docker/compose/releases/download/v5.0.1/docker-compose-linux-{{ ansible_facts.architecture }}"
        dest: "/usr/local/lib/docker/cli-plugins/docker-compose"
        mode: "0755"
        checksum: >-
          {%- if ansible_facts.architecture == 'aarch64' -%}
            sha256:e3b36491a75f92c35ebfbbe6e4741bd2429664edf3971427983d67c0b21e7d1d
          {%- else -%}
            sha256:cdc1df64412ed009312afbc044b3625144d06c07736e2f7a77fb0460531b9327
          {%- endif -%}

    - name: "Install Docker Buildx plugin"
      ansible.builtin.get_url:
        url: "https://github.com/docker/buildx/releases/download/v0.30.1/buildx-v0.30.1.linux-{{ 'arm64' if ansible_facts.architecture == 'aarch64' else 'amd64' }}"
        dest: "/usr/local/lib/docker/cli-plugins/docker-buildx"
        mode: "0755"
        checksum: >-
          {%- if ansible_facts.architecture == 'aarch64' -%}
            sha256:31d012d52d6df68aef4b55db62330967b562811f0de30cdfaa4505f314797c76
          {%- else -%}
            sha256:c37114fcd034025ec68e224657c8a5a850df472ded3ddcbca75ad3a7ebb9710d
          {%- endif -%}
...
